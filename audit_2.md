# Аудит проекта Ubuntu Task Manager (UTM) v2.0.0

**Дата аудита:** 2026-01-22
**Аудитор:** Claude Opus 4.5
**Версия проекта:** 2.0.0

---

## 1. Общая информация о проекте

### 1.1 Описание
Ubuntu Task Manager (UTM) — полнофункциональный TUI-дашборд для мониторинга и управления Linux-серверами (Ubuntu/Debian) непосредственно из терминала. Построен на базе фреймворка Textual.

### 1.2 Основные характеристики
- **Язык:** Python 3.8+
- **Фреймворк UI:** Textual >= 0.50.0
- **Целевая платформа:** Linux (Ubuntu/Debian) с systemd
- **Лицензия:** MIT

### 1.3 Функциональные возможности
- 9 вкладок мониторинга (Processes, Services, Packages, Containers, Tasks, Network, Users, Disks, Logging)
- Компактная системная панель со спарклайн-графиками
- Управление Docker-контейнерами
- Интеграция с Fail2ban
- Мониторинг cron-заданий и systemd-таймеров
- Управление сервисами (start/stop/restart)
- Экспорт снапшотов в JSON

---

## 2. Архитектура проекта

### 2.1 Структура каталогов

```
homeserver-inventory/
├── src/                          # Исходный код
│   ├── main.py                   # Точка входа
│   ├── const.py                  # Константы приложения
│   ├── list_tasks.py             # CLI для просмотра задач
│   ├── collectors/               # Модули сбора данных (Model)
│   │   ├── base.py               # Абстрактный базовый класс
│   │   ├── system.py             # Системная информация
│   │   ├── services.py           # Сервисы и Docker
│   │   ├── network.py            # Сетевая информация
│   │   ├── tasks.py              # Cron и systemd timers
│   │   ├── processes.py          # Процессы
│   │   └── users.py              # Пользователи
│   ├── dashboard/                # UI компоненты (View/Controller)
│   │   ├── app.py                # Главный класс приложения
│   │   └── widgets/              # Виджеты для вкладок
│   └── utils/                    # Утилиты
│       └── logger.py             # Логирование
├── config/                       # Конфигурация
│   └── config.yaml               # Главный конфиг
├── tests/                        # Тесты
├── docs/                         # Документация
├── scripts/                      # Вспомогательные скрипты
├── requirements.txt              # Зависимости
├── requirements-dev.txt          # Dev-зависимости
├── Dockerfile                    # Docker-образ
└── pytest.ini                    # Конфигурация pytest
```

### 2.2 Архитектурные паттерны

| Паттерн | Реализация |
|---------|------------|
| **MVC** | Collectors (Model), Widgets (View), App (Controller) |
| **Template Method** | `BaseCollector` определяет интерфейс для всех коллекторов |
| **Event-Driven** | Textual обрабатывает события таймера и пользовательского ввода |

### 2.3 Оценка архитектуры

**Сильные стороны:**
- Чёткое разделение ответственности между слоями
- Модульная структура позволяет легко добавлять новые коллекторы и виджеты
- Использование абстрактного базового класса обеспечивает единообразие коллекторов
- Конфигурация через YAML и переменные окружения

**Слабые стороны:**
- Отсутствует слой репозиториев/сервисов между коллекторами и UI
- Некоторые виджеты напрямую вызывают системные команды (нарушение слоёв)
- Нет механизма кэширования на уровне архитектуры (реализовано ad-hoc в отдельных коллекторах)

**Рекомендации:**
1. Ввести слой сервисов для бизнес-логики
2. Централизовать кэширование данных
3. Добавить интерфейсы для тестирования (dependency injection)

---

## 3. Анализ зависимостей

### 3.1 Основные зависимости

| Пакет | Версия | Назначение | Риск |
|-------|--------|------------|------|
| textual | >= 0.50.0 | TUI-фреймворк | Низкий |
| rich | >= 13.7.0 | Форматирование терминала | Низкий |
| psutil | >= 5.9.0 | Системная информация | Низкий |
| pyyaml | >= 6.0 | Парсинг YAML | Низкий |
| docker | >= 7.0.0 | Docker API | Средний |
| croniter | >= 2.0.0 | Парсинг cron | Низкий |
| python-dateutil | >= 2.8.0 | Работа с датами | Низкий |
| python-dotenv | >= 1.0.0 | Переменные окружения | Низкий |
| python-json-logger | >= 2.0.0 | JSON-логирование | Низкий |
| sentry-sdk | >= 1.40.0 | Отслеживание ошибок | Низкий |

### 3.2 Dev-зависимости

| Пакет | Назначение |
|-------|------------|
| pytest | Тестирование |
| pytest-cov | Покрытие кода |
| bandit | Статический анализ безопасности |

### 3.3 Оценка зависимостей

**Положительные аспекты:**
- Все зависимости — популярные, хорошо поддерживаемые пакеты
- Минимальное количество зависимостей
- Указаны минимальные версии с `>=`

**Рекомендации:**
1. Рассмотреть использование `pyproject.toml` вместо `requirements.txt`
2. Добавить фиксацию версий через `pip-compile` или poetry lock
3. Добавить зависимость для type hints (`mypy`, `types-*`)

---

## 4. Анализ качества кода

### 4.1 Стиль и форматирование

| Критерий | Оценка | Комментарий |
|----------|--------|-------------|
| Соглашение об именовании | 4/5 | Соответствует PEP8, snake_case для функций |
| Документация | 3/5 | Docstrings присутствуют, но не везде |
| Type hints | 2/5 | Частично используются, не везде |
| Комментарии | 3/5 | Присутствуют в сложных местах |

### 4.2 Примеры проблем в коде

#### 4.2.1 Bare except clauses
**Файл:** `src/collectors/system.py` (строки 110-112, 156, 250, 311, 706, 715, 728)
```python
# Плохо
except:
    pass

# Хорошо
except Exception as e:
    logger.debug(f"Error: {e}")
```

#### 4.2.2 Пустые except блоки
**Файл:** `src/collectors/network.py` (строки 583-585)
```python
except Exception:
    pass  # Потеря информации об ошибке
```

#### 4.2.3 Shell=True в subprocess
**Файл:** `src/collectors/system.py` (строки 66-68, 83-85)
```python
subprocess.run(
    "dpkg-query -W -f='${Package} ${Version}\n'",
    shell=True, ...  # Потенциальный риск
)
```

### 4.3 Метрики качества

| Метрика | Значение | Целевое |
|---------|----------|---------|
| Цикломатическая сложность (avg) | ~8 | < 10 |
| Размер функций (avg строк) | ~25 | < 30 |
| Глубина вложенности (max) | 4 | < 4 |
| Дублирование кода | Низкое | Низкое |

### 4.4 Рекомендации по качеству кода

1. **Добавить type hints во все публичные методы**
2. **Заменить bare except на конкретные исключения**
3. **Добавить линтеры в CI/CD** (flake8, pylint, mypy)
4. **Использовать pre-commit hooks** для автоформатирования (black, isort)
5. **Разбить длинные методы** (например, `_get_disk_info` в system.py — 200+ строк)

---

## 5. Анализ безопасности

### 5.1 Выявленные проблемы

#### 5.1.1 КРИТИЧЕСКИЕ (требуют исправления)

| ID | Описание | Файл | Строка |
|----|----------|------|--------|
| SEC-001 | Использование `shell=True` в subprocess | system.py | 66, 83 |
| SEC-002 | Использование `shell=True` с переменными | network.py | 368, 539 |
| SEC-003 | Внешний HTTP-запрос без валидации IP | network.py | 578 |

#### 5.1.2 СРЕДНИЕ

| ID | Описание | Файл | Строка |
|----|----------|------|--------|
| SEC-004 | Отсутствие валидации путей файлов | tasks.py | 182-214 |
| SEC-005 | Хранение данных в незашифрованном JSON | network.py | 34-42 |
| SEC-006 | Использование sudo в коде | system.py | 587 |

#### 5.1.3 НИЗКИЕ

| ID | Описание | Файл | Строка |
|----|----------|------|--------|
| SEC-007 | Раскрытие информации о системе в логах | logger.py | все |
| SEC-008 | Отсутствие rate limiting для API | network.py | 578 |

### 5.2 Детальный анализ критических проблем

#### SEC-001, SEC-002: Shell Injection
```python
# Уязвимый код (network.py:368)
cmd = f"grep 'Unban' {log_file} | tail -n {limit * 3}"
result = subprocess.run(cmd, shell=True, ...)

# Безопасная альтернатива
result = subprocess.run(
    ['grep', 'Unban', log_file],
    capture_output=True, text=True, timeout=5
)
```

#### SEC-003: SSRF (Server-Side Request Forgery)
```python
# Уязвимый код (network.py:578)
url = f"http://ip-api.com/json/{ip}?fields=country,org"

# Рекомендация: добавить валидацию IP
import ipaddress
try:
    ipaddress.ip_address(ip)
except ValueError:
    return default_info
```

### 5.3 Рекомендации по безопасности

1. **Заменить все shell=True на массивы аргументов**
2. **Добавить валидацию входных данных** (особенно IP-адресов)
3. **Использовать shlex.quote()** для экранирования при необходимости shell
4. **Добавить rate limiting** для внешних API-запросов
5. **Рассмотреть шифрование** кэшированных данных (bans_db.json)
6. **Запустить bandit** и исправить все найденные проблемы

---

## 6. Анализ тестирования

### 6.1 Текущее состояние

| Метрика | Значение |
|---------|----------|
| Количество тестовых файлов | 4 |
| Количество тест-кейсов | ~15 |
| Покрытие кода (оценка) | 10-15% |

### 6.2 Анализ существующих тестов

**test_services.py:**
- Тестирует парсинг вывода systemctl
- Использует mocking для subprocess
- Хорошее покрытие основных сценариев

**test_tasks.py:**
- Тестирует парсинг cron-записей
- Покрывает различные форматы cron
- Тестирует преобразование в human-readable формат

### 6.3 Недостатки тестирования

1. **Отсутствуют тесты для:**
   - UI компонентов (widgets)
   - Интеграционного взаимодействия
   - Network collector
   - System collector
   - Processes collector

2. **Нет тестов для:**
   - Edge cases
   - Error handling
   - Concurrency

3. **Отсутствуют:**
   - Интеграционные тесты
   - E2E тесты
   - Performance тесты
   - Security тесты

### 6.4 Рекомендации по тестированию

1. **Увеличить покрытие до 70%+** для критических компонентов
2. **Добавить тесты для всех коллекторов**
3. **Создать fixtures** для типичных данных системы
4. **Добавить integration tests** с реальными командами (в Docker)
5. **Настроить pytest-cov** в CI/CD для отслеживания покрытия
6. **Добавить property-based тесты** (hypothesis) для парсеров

---

## 7. Анализ документации

### 7.1 Существующая документация

| Файл | Описание | Качество |
|------|----------|----------|
| README.md | Основная документация | 4/5 |
| docs/QUICKSTART.md | Быстрый старт | 3/5 |
| docs/CRON_MONITORING.md | Мониторинг cron | 4/5 |
| docs/EXAMPLES.md | Примеры расширения | 3/5 |
| docs/CHANGELOG.md | История изменений | 3/5 |

### 7.2 Сильные стороны

- Хорошее описание архитектуры в README
- Понятные примеры конфигурации
- Документированы горячие клавиши

### 7.3 Недостатки

1. **Отсутствует API-документация**
2. **Нет документации по развёртыванию в production**
3. **Отсутствует troubleshooting guide**
4. **Нет changelog для последних версий**

### 7.4 Рекомендации

1. **Добавить Sphinx/MkDocs** для генерации документации
2. **Создать CONTRIBUTING.md** с гайдлайнами для контрибьюторов
3. **Добавить inline-документацию** (docstrings) во все публичные методы
4. **Создать FAQ** с частыми проблемами
5. **Документировать переменные окружения** подробнее

---

## 8. Производительность и оптимизации

### 8.1 Текущие оптимизации

| Оптимизация | Файл | Описание |
|-------------|------|----------|
| Кэширование пакетов | system.py | 30 минут для списка пакетов |
| Кэширование SMART | system.py | 5 минут для SMART-данных |
| IP геолокация | network.py | Локальный кэш в JSON |
| Background workers | widgets | Textual @work decorator |

### 8.2 Выявленные проблемы производительности

1. **Высокая нагрузка при старте** — все коллекторы обновляются одновременно
2. **Блокирующие вызовы subprocess** — могут замедлять UI
3. **Отсутствие пагинации** для больших списков (процессы, пакеты)
4. **Частые записи в bans_db.json** — I/O overhead

### 8.3 Рекомендации по производительности

1. **Staggered initialization** — последовательный запуск коллекторов
2. **Async subprocess** — использовать asyncio.create_subprocess_exec
3. **Виртуализация списков** — для таблиц с 1000+ элементов
4. **Batch writes** — накапливать изменения перед записью в файл
5. **Profiling** — добавить метрики времени выполнения коллекторов

---

## 9. Docker и развёртывание

### 9.1 Анализ Dockerfile

**Положительные аспекты:**
- Multi-stage build для уменьшения размера
- Использование slim-образа
- Правильные ENV переменные

**Проблемы:**
```dockerfile
# Нет pinning версий пакетов
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    python3-dev
```

### 9.2 Рекомендации по Docker

1. **Добавить healthcheck** в Dockerfile
2. **Зафиксировать версии** apt-пакетов
3. **Создать docker-compose.yml** для удобного запуска
4. **Добавить non-root user** для запуска приложения
5. **Документировать необходимые volumes и capabilities**

---

## 10. CI/CD и инфраструктура

### 10.1 Текущее состояние

- Отсутствует настроенный CI/CD пайплайн
- Есть пример `docs/examples/ci.yml`
- Настроен pytest.ini

### 10.2 Рекомендуемый CI/CD пайплайн

```yaml
# .github/workflows/ci.yml
stages:
  - lint (flake8, mypy, bandit)
  - test (pytest with coverage)
  - security (bandit, safety)
  - build (Docker image)
  - release (publish to PyPI/Docker Hub)
```

### 10.3 Рекомендации

1. **Настроить GitHub Actions** для автоматического тестирования
2. **Добавить pre-commit hooks** (black, isort, flake8)
3. **Настроить Dependabot** для обновления зависимостей
4. **Добавить автоматические релизы** через semantic versioning

---

## 11. Сводная таблица проблем

### 11.1 Критические (P0)

| # | Проблема | Приоритет | Сложность |
|---|----------|-----------|-----------|
| 1 | Shell injection через shell=True | Критический | Низкая |
| 2 | Отсутствие валидации IP в API | Критический | Низкая |

### 11.2 Высокие (P1)

| # | Проблема | Приоритет | Сложность |
|---|----------|-----------|-----------|
| 3 | Низкое покрытие тестами | Высокий | Средняя |
| 4 | Отсутствие CI/CD | Высокий | Средняя |
| 5 | Bare except clauses | Высокий | Низкая |

### 11.3 Средние (P2)

| # | Проблема | Приоритет | Сложность |
|---|----------|-----------|-----------|
| 6 | Неполные type hints | Средний | Средняя |
| 7 | Отсутствие API документации | Средний | Средняя |
| 8 | Длинные методы (>100 строк) | Средний | Средняя |

### 11.4 Низкие (P3)

| # | Проблема | Приоритет | Сложность |
|---|----------|-----------|-----------|
| 9 | Отсутствие pyproject.toml | Низкий | Низкая |
| 10 | Нет Docker healthcheck | Низкий | Низкая |
| 11 | Отсутствие CONTRIBUTING.md | Низкий | Низкая |

---

## 12. План улучшений

### 12.1 Немедленные действия (Sprint 1)

1. [ ] Исправить shell injection уязвимости
2. [ ] Добавить валидацию IP-адресов
3. [ ] Заменить bare except на конкретные исключения
4. [ ] Настроить базовый CI/CD с тестами

### 12.2 Краткосрочные (Sprint 2-3)

1. [ ] Увеличить покрытие тестами до 50%
2. [ ] Добавить type hints в публичные методы
3. [ ] Настроить линтеры (flake8, mypy)
4. [ ] Создать docker-compose.yml

### 12.3 Среднесрочные (Sprint 4-6)

1. [ ] Рефакторинг длинных методов
2. [ ] Миграция на pyproject.toml
3. [ ] Написать API-документацию (Sphinx)
4. [ ] Добавить интеграционные тесты

### 12.4 Долгосрочные

1. [ ] Внедрить dependency injection
2. [ ] Добавить performance мониторинг
3. [ ] Создать plugin систему для расширений
4. [ ] Поддержка других дистрибутивов (RHEL, Arch)

---

## 13. Заключение

### 13.1 Общая оценка

| Аспект | Оценка | Комментарий |
|--------|--------|-------------|
| Архитектура | 4/5 | Хорошее разделение слоёв, есть возможности для улучшения |
| Качество кода | 3/5 | Читаемый код, но есть проблемы с обработкой ошибок |
| Безопасность | 2/5 | Критические уязвимости требуют исправления |
| Тестирование | 2/5 | Низкое покрытие, отсутствуют важные тесты |
| Документация | 3/5 | Базовая документация есть, требуется расширение |
| Производительность | 3/5 | Базовые оптимизации присутствуют |
| DevOps | 2/5 | Отсутствует CI/CD, Docker требует улучшений |

### 13.2 Итоговая оценка: **3.0/5** (Удовлетворительно)

Проект демонстрирует хорошую архитектуру и функциональность, но требует внимания к безопасности и тестированию. Основные рекомендации:

1. **Срочно:** Исправить уязвимости безопасности (shell injection)
2. **Важно:** Увеличить покрытие тестами и настроить CI/CD
3. **Желательно:** Улучшить документацию и добавить type hints

---

*Аудит выполнен: 2026-01-22*
*Следующий аудит рекомендуется: через 3 месяца или после крупных изменений*
