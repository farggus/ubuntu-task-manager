# Аудит проекта Ubuntu Task Manager (UTM)
**Дата:** 22 января 2026 г.
**Версия аудита:** 1.0

## 1. Качество кода (Code Quality)

### Сильные стороны
*   **Структура:** Код логично разбит на модули (`collectors`, `dashboard`, `utils`).
*   **Стиль:** Визуально код соответствует PEP 8, используются тайп-хинты (type hints).
*   **Обработка ошибок:** В большинстве коллекторов реализована изоляция ошибок (падение одного модуля не рушит всё приложение).

### Проблемы
*   **Отсутствие линтеров:** В `requirements-dev.txt` отсутствуют инструменты статического анализа стиля (flake8, black, ruff, mypy). Стиль не форсируется автоматически.
*   **Зависимость от Shell:** Код чрезмерно полагается на вызовы системных утилит через `subprocess` (парсинг вывода `ip`, `systemctl`, `ufw`), вместо использования Python-библиотек (например, `pyroute2`, `systemd-python`). Это делает код хрупким и сложным для поддержки.
*   **Подавление ошибок:** Обнаружены паттерны `try: ... except: pass`, которые скрывают реальные проблемы (Bandit B110).

## 2. Безопасность (Security)

**Инструмент:** Bandit
**Результат:** 84 проблемы (2 High, 1 Medium, 81 Low).

### Критические уязвимости (High Severity)
Обнаружено использование `shell=True` с форматированием строк, что создает риск Command Injection:
1.  `src/collectors/network.py` (строка 370): `grep` с подстановкой `log_file`.
2.  `src/collectors/network.py` (строка 540): `grep` с подстановкой `ip`.

### Другие риски
*   **Low Severity:** Множественные вызовы `subprocess` без полного пути к исполняемому файлу (зависимость от переменной PATH).
*   **Отсутствие валидации:** Данные из внешних команд часто принимаются без проверки перед дальнейшим использованием.

## 3. Архитектура (Architecture)

*   **Модульность:** Разделение на `Dashboard` (UI) и `Collectors` (Data) выполнено корректно. Это позволяет легко добавлять новые источники данных.
*   **Связность:** UI компоненты (`widgets`) слишком сильно связаны с логикой сбора данных. В идеале виджеты должны только отображать данные, а не инициировать их сбор или обработку.
*   **Масштабируемость:** Текущая архитектура синхронна (за исключением использования потоков в Textual). Тяжелые операции сбора данных (например, таймауты при опросе сети) могут "фризить" интерфейс, если они не вынесены корректно в воркеры.

## 4. Тестирование (Testing)

*   **Статус:** Тесты проходят успешно (19 passed).
*   **Покрытие:** Тестами покрыты основные коллекторы (`system`, `services`, `tasks`) и проверка целостности.
*   **Пробелы:** Отсутствуют тесты для UI-компонентов и обработки граничных случаев (например, отсутствие утилит в системе).
*   **Время выполнения:** ~3 секунды. Самый медленный тест: `test_cpu_memory` (2.39s).

## 5. Конфигурация и CI/CD

*   **Конфигурация:** Используется `config/config.yaml` и переменные окружения (`.env`). Это хорошая практика. Секреты (если есть) вынесены в env.
*   **CI/CD:** **Полностью отсутствует**. Нет директории `.github/workflows`. Процессы тестирования и линтинга не автоматизированы.
*   **Dev-окружение:** `requirements-dev.txt` минималистичен, не хватает инструментов для pre-commit хуков.

## 6. Рекомендации

1.  **Безопасность (Приоритет №1):**
    *   Устранить использование `shell=True` в `src/collectors/network.py`.
    *   Заменить вызовы `grep` на чтение файлов средствами Python.

2.  **Инфраструктура:**
    *   Создать CI пайплайн (GitHub Actions) для запуска тестов и Bandit на каждом коммите.
    *   Добавить `flake8` или `ruff` в зависимости и настроить pre-commit hooks.

3.  **Рефакторинг:**
    *   Начать постепенный отказ от парсинга CLI-вывода в пользу нативных библиотек Python (`psutil` уже используется, расширить на `pyroute2` и docker SDK).
    *   Убрать "пустые" `except: pass` и добавить логирование ошибок.

4.  **Код:**
    *   Указать полные пути к бинарникам (например, `/usr/bin/systemctl`) или реализовать механизм их поиска при старте.
